#!/usr/bin/env bash

indent() {
    sed -u 's/^/       /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "---- Multi-procfile buildpack debug info ----" | indent
echo "BUILD_DIR = ${BUILD_DIR}" | indent
echo "CACHE_DIR = ${CACHE_DIR}" | indent
echo "ENV_DIR   = ${ENV_DIR}" | indent

echo "Reading PROCFILE from ${ENV_DIR}/PROCFILE..." | indent
PROCFILE=$(cat "${ENV_DIR}/PROCFILE" 2>/dev/null)

if [[ -z "${PROCFILE}" ]]; then
    echo "‚ùå PROCFILE environment variable was not set or is empty. Aborting." | indent
    echo "‚ÑπÔ∏è To fix: heroku config:set PROCFILE=sockets/Procfile" | indent
    exit 1
fi

echo "‚úÖ Detected PROCFILE = '${PROCFILE}'" | indent

SOURCE_PROCFILE="${BUILD_DIR}/${PROCFILE}"
DEST_PROCFILE="${BUILD_DIR}/Procfile"

echo "üîç Checking if file exists: ${SOURCE_PROCFILE}" | indent

if [ ! -f "${SOURCE_PROCFILE}" ]; then
    echo "‚ùå ERROR: '${SOURCE_PROCFILE}' does not exist." | indent

    echo "üìÅ Listing contents of '${BUILD_DIR}':" | indent
    ls -al "${BUILD_DIR}" | indent

    echo "üìÅ Listing contents of '${BUILD_DIR}/$(dirname "${PROCFILE}")':" | indent
    ls -al "${BUILD_DIR}/$(dirname "${PROCFILE}")" 2>/dev/null || echo "‚ö†Ô∏è Folder does not exist" | indent

    echo "‚õî Aborting because the Procfile could not be found." | indent
    exit 1
fi

# Copy the Procfile into root
cp "${SOURCE_PROCFILE}" "${DEST_PROCFILE}"
if [[ $? -ne 0 ]]; then
    echo "‚ùå FAILED to copy Procfile from '${SOURCE_PROCFILE}'" | indent
    exit 1
else
    echo "‚úÖ Copied '${PROCFILE}' as root-level Procfile successfully" | indent
fi

APP_DIR=$(dirname "${SOURCE_PROCFILE}")

echo "üìÅ Scanning contents of APP_DIR (${APP_DIR}):" | indent
ls -al "${APP_DIR}" | indent

# Copy package.json
if [[ -f "${APP_DIR}/package.json" ]]; then
    echo "üì¶ Copying package.json from ${APP_DIR}" | indent
    cp "${APP_DIR}/package.json" "${BUILD_DIR}/package.json"
else
    echo "‚ö†Ô∏è package.json not found in ${APP_DIR}" | indent
fi

# Copy package-lock.json
if [[ -f "${APP_DIR}/package-lock.json" ]]; then
    echo "üì¶ Copying package-lock.json from ${APP_DIR}" | indent
    cp "${APP_DIR}/package-lock.json" "${BUILD_DIR}/package-lock.json"
else
    echo "‚ö†Ô∏è package-lock.json not found in ${APP_DIR}" | indent
fi

# Copy tsconfig.json
if [[ -f "${APP_DIR}/tsconfig.json" ]]; then
    echo "üõ†Ô∏è Copying tsconfig.json from ${APP_DIR}" | indent
    cp "${APP_DIR}/tsconfig.json" "${BUILD_DIR}/tsconfig.json"
else
    echo "‚ÑπÔ∏è No tsconfig.json found in ${APP_DIR}" | indent
fi

# Copy app.json
if [[ -f "${APP_DIR}/app.json" ]]; then
    echo "üß© Copying app.json from ${APP_DIR}" | indent
    cp "${APP_DIR}/app.json" "${BUILD_DIR}/app.json"
    echo "‚úÖ Copied app.json successfully" | indent
else
    echo "‚ÑπÔ∏è No app.json found in ${APP_DIR}" | indent
fi

echo "‚úÖ Multi-procfile setup completed. Handing off to next buildpack..." | indent
echo "---------------------------------------------------------------" | indent
